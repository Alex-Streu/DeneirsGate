"use strict";const through=require("through2"),uglify=require("terser"),minimatch=require("minimatch"),path=require("path"),Vinyl=require("vinyl"),PluginError=require("plugin-error"),colors=require("ansi-colors"),reSourceMapComment=/\n\/\/# sourceMappingURL=.+?$/,pathSeparatorRe=/[\/\\]/g,jsExtensions=/\.m?js$/;function parseExt(e,r=".js"){let t={};return t=e?"string"==typeof e?{min:e,src:r}:{min:e.min||"-min"+r,src:e.src||r}:{min:"-min"+r,src:r}}function formatError(e,r){let t="stdin"===e.file?r.path:e.file,n="";t=t||r.path;let s=path.relative(process.cwd(),t);return n+=colors.underline(s)+"\n",n+=e.message+" (line: "+e.line+", col: "+e.col+", pos: "+e.pos,e.message=colors.red(n),e}module.exports=function(e){let r=e||{};return r.output=r.output||{},through.obj(function(e,t,n){if(e.isNull())return this.push(e),n();if(e.isStream())return this.emit("end"),new n(PluginError("gulp-minify","Streaming not supported:"+e.path));let s,o,i=!1;if(r.exclude&&(i=r.exclude.some(function(r){return path.dirname(e.path).split(pathSeparatorRe).some(function(e){return minimatch(e,r)})})),!i&&r.ignoreFiles&&(i=r.ignoreFiles.some(function(r){return minimatch(path.basename(e.path),r)})),i||!path.extname(e.path).match(jsExtensions))return this.push(e),n();e.sourceMap&&(r.outSourceMap=e.relative,""!==e.sourceMap.mappings&&(r.inSourceMap=e.sourceMap),o=e.sourceMap),"all"===r.preserveComments?r.output.comments=!0:"some"===r.preserveComments?r.output.comments=/^!|@preserve|@license|@cc_on/i:"function"==typeof r.preserveComments&&(r.output.comments=r.preserveComments),r.fromString=!r.hasOwnProperty("fromString")||r.fromString;let u=parseExt(r.ext,path.extname(e.path)),p=new Vinyl({base:e.base,path:Array.isArray(u.min)?e.path.replace(u.min[0],u.min[1]):e.path.replace(jsExtensions,u.min)});const a={mangle:void 0===r.mangle||r.mangle,output:void 0!==r.output?r.output:null,compress:void 0!==r.compress?r.compress:{},sourceMap:!!e.sourceMap};try{s=uglify.minify(String(e.contents),a),p.contents=new Buffer(s.code.replace(reSourceMapComment,""))}catch(r){return this.emit("end"),n(new PluginError("gulp-minify",formatError(r,e)))}e.sourceMap&&(p.sourceMap=JSON.parse(s.map),p.sourceMap.sourcesContent=o.sourcesContent,p.sourceMap.sources=o.sources),this.push(p),!0!==r.noSource&&(e.path=e.path.replace(jsExtensions,u.src),this.push(e)),n()})};